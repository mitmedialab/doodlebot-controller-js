<!-- 
                     FILE NOTE 
THE SCRIPT FOR THIS FILE IS MAINLY DONE IN test-index.js 
AND THERE IS NO NEED FOR virtualMode.js ANYMORE
-->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Virtual Mode</title>
    <!--my css-->
    <!-- <link rel="stylesheet" href="./preindex-style.css"></link> -->
    <link rel="stylesheet" href="./virtualMode-style.css"></link>
    <link rel="stylesheet" href="./test-style.css"></link>
    <!--bootstrap css and scripts-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

    <!--The link below is for the bluetooth icon-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--The link below is for the settings icon-->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!--Font-->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Audiowide">

</head>

<body id="body">
    <div class="container">
        <div id="mySidebar" class="sidebar">
            <div id = "controls" class="card">
                <div class="card-header">
                    <div style="display:flex; align-items: center;"><h5 style="margin-left: 20%;">Controls and Settings</h5>
                    <a valid-mode="camera" id="camera_settings" href="#" style="margin-left: 12%;" class="material-symbols-outlined">
                    settings_photo_camera</a>
                    
                    </div>
                </div>

                <!--Modal start-->
                <div class="modal" id="myModal">
                    <div class="modal-content">
                        <div style="display:flex; align-items: center;">
                            <h5 style="margin-top: 5px;">Camera Settings</h5><span style="margin-left: 50%;" class="close">&times;</span>
                        </div>
                        <canvas id="arucoCanvasDebug" width="640" height="640"></canvas>

                        <hr>
                        <p>This is the modal content</p>
                        <textarea id="logBox" rows="10" cols="100"></textarea>
                        <select id="devicesSelect"></select>
                        <button id="updateCornersButton" class="btn btn-outline-success">Update Corners</button>
                    </div>
                </div>
                <!--Modal end-->
                
                <div class="card-body">
                    <center><button valid-mode="camera" id="bluetooth_button" class="btn btn-outline-success mb-3">Connect to Bluetooth <i class="fa fa-bluetooth"></i></button></center>
                    <center><small>Select a bot with your mouse</small></center>
                    <div class="row">
                        <div class="col p-1">
                            <p style="font-size: 14px; margin-bottom: 0;">Select policy</p>
                            <div class="form-check policy-inactive">
                                <input type="checkbox" class="form-check-input" id="random_checkbox" name="random_checkbox" value="random_checkbox">
                                <label class="form-check-label" for="check1" style="font-size: 14px;">Random</label>
                            </div>
                            <div class="form-check policy-inactive">
                                <input type="checkbox" class="form-check-input" id="follow_checkbox" name="follow_checkbox" value="follow_checkbox">
                                <label class="form-check-label" for="check2" style="font-size: 14px;">
                                    Follow 
                                    <select class="form-select-sm" id="follow_select" name="follow_select">
                                        <option value="None">-- Select a bot to follow --</option>
                                        <!-- <option value="euclidian">Random</option> -->
                                        <!-- <option value="euclidian">Euclidean</option>
                                        <option value="euclidian">Manhattan</option>
                                        <option value="euclidian">Dijkstra</option> -->
                                    </select>
                                </label>
                            </div>
                            <div class="form-check policy-inactive">
                                <input type="checkbox" class="form-check-input" id="run_away_from_checkbox" name="run_away_from_checkbox" value="run_away_from_checkbox">
                                <label class="form-check-label" style="font-size: 14px;">
                                    Run away from
                                    <select class="form-select-sm" id="run_away_from_select" name="run_away_from_select">
                                        <option value="None">-- Select a bot to run from--</option>
                                        <!-- <option value="euclidian">Random</option> -->
                                        <!-- <option value="euclidian">Euclidean</option>
                                        <option value="euclidian">Manhattan</option>
                                        <option value="euclidian">Dijkstra</option> -->
                                    </select>
                                </label>
                            </div>
                            <div class="form-check policy-inactive">
                                <input type="checkbox" class="form-check-input" id="collect_checkbox" name="collect_checkbox" value="collect_checkbox">
                                <label class="form-check-label" style="font-size: 14px;">
                                    Collect
                                    <select class="form-select-sm" id="collect_select" name="collect_select">
                                        <option value="None">-- Select a type to collect--</option>
                                    </select>
                                </label>
                            </div>
                            <label for="sel1" class="form-label" style="font-size: 14px; margin-top: 20px;">
                                Distance Type
                            </label>
                            <select class="form-select form-select-sm" id="distanceType" name="distanceType" style="width:80%;">
                                <!-- <option value="euclidian">Random</option> -->
                                <option value="euclidian">Euclidean</option>
                                <option value="euclidian">Manhattan</option>
                                <option value="euclidian">Dijkstra</option>
                            </select>
                            <!-- <div class="form-check mt-4">
                                <input type="checkbox" class="form-check-input" id="check1" name="option1" value="something">
                                <label class="form-check-label" for="check1" style="font-size: 14px;">Only consider reachable points</label>
                            </div> -->
                            
                        </div>
                        <!-- <div class="col p-3">
                            <center><small>Manual Controls</small></center>
                            <center>
                            <img alt="controls" src="../assets/DB_Controls_1.png" style="width:170px; height:170px; margin-top: 15px;">
                            </center>
                           
                        </div> -->
                        
                    </div>
                </div>
            </div>
            <div id="objects" class="card">
                <div valid-mode="virtual" class="card-header"><center><h5>Available Objects</h5></center></div>
                <div valid-mode="camera" class="card-header"><center><h5>Detected Objects</h5></center></div>

                <div class="card-body" id="objects-inner">
                    <center valid-mode="virtual"><small>Drag and drop into the grid</small></center>
                    <p style="margin-bottom: 0;">Bots</p>
                    <div id="bots" class="border border-dark p-2">
                        
                    </div>
                    <p style="margin-bottom: 0; margin-top: 15px;">Obstacles</p>
                    <div id="obstacles" class="border border-dark p-2">
                        
                    </div>
                    <p style="margin-bottom: 0; margin-top: 15px;">Rewards</p>
                    <div id="coins" class="border border-dark p-2">
                        
                    </div>
                </div>
            </div>
        </div>
    
        <div id="main">
            <!-- <button id = "startbtn" class="startbtn btn btn-success" onclick="start()">Start</button>
            <div id="gridSpace" class="border border-5 border-light"></div> -->
            
            <!--Integration html code-->
            <!-- <div id="waitingRoom">
            </div> -->
            <div id="waitingRoom">
            </div>
            <div style="display:flex; align-items: center;">
                <button id="startBotsButton" class="bot-start" style="padding:5px; margin-bottom:10px;">Start Moving!</button>
                <div style="width:280px;"></div>
                <div valid-mode="camera" id="activate_camera_div">
                    <label class="form-check-label mt-1" for="activate_camera" style="font-size: 14px; margin-right:5px; color:antiquewhite;">Activate Camera</label>
                    <input type="checkbox" class="form-check-input" id="activate_camera" name="activate_camera" disabled>
                    <br/>
                    <div id="remote_ip_container" class="remote-ip-hidden">
                        <input type="text" class="form-check-text" id="remote_ip_input" name="activate_camera">
                        <label class="form-check-label mt-1" for="remote_ip_input" style="font-size: 14px; margin-right:5px; color:antiquewhite;"><button class="btn btn-warning" id="remote_ip_connect">Connect!</button></label>
                    </div>
                </div>
            </div>
            <!--If virtual mode-->
            <div id="gridContainer" valid-mode="virtual" id="outer-dropzone" class="dropzone"></div>

            <!--If camera mode-->
            <image valid-mode="camera" id="image_from_stream" style="display: none"/>
            <!-- <video valid-mode="camera" id="videoId" autoplay style="display: none" type="video/mp4"> -->
                <!-- <source  src="http://192.168.41.240:56000/mjpeg" type="video/webm"></source> -->
                <!-- <source src="http://wowzaec2demo.streamlock.net/vod/mp4:BigBuckBunny_115k.mp4" type="video/mp4"></source> -->
            <!-- </video> -->
            <div valid-mode="camera" id="canvasContainer">
            <canvas valid-mode="camera" id="arucoCanvasOutputGrid" class="dropzone"></canvas>
            </div>
            <!----------------->

            <div class="form-check" style="padding-top:20px;">
                <input type="checkbox" class="form-check-input" id="check_gridlines" name="option2">
                <label class="form-check-label" for="check_gridlines" style="font-size: 14px; color:antiquewhite;">Hide gridlines</label>
            </div>
            <!--Integration html code-->

        </div>
      
    </div>
    
    <!--Adding interact.js-->
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <!-- <script type="module" src="./test.js"></script> -->
    <!-- <script type="text/javascript" src="./virtualMode.js"></script> -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script type="module" src="./test-interact.js"></script>
    <script type="text/javascript" src="./graph.js"></script>
    <script type="text/javascript" src="./grid-graph.js"></script>
    <script type="text/javascript" src="./grid.js"></script>
    <script type="module" src="./test-index.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>


    <!-- Specific to camera mode-->
    <script type="module" src="../physical-ui-handler.js"></script>
    <script
        async
        src="../marker_detector/opencv_compiled.js"
        id="opencvjs"
        type="text/javascript"
    ></script>
    
    <script type="module">
        import "https://cdn.interactjs.io/v1.9.20/auto-start/index.js";
        import "https://cdn.interactjs.io/v1.9.20/actions/drag/index.js";
        import "https://cdn.interactjs.io/v1.9.20/actions/resize/index.js";
        import "https://cdn.interactjs.io/v1.9.20/modifiers/index.js";
        import "https://cdn.interactjs.io/v1.9.20/dev-tools/index.js";
        import interact from "https://cdn.interactjs.io/v1.9.20/interactjs/index.js";

        /**
         *
         * @param {*} id ${TYPE}-${id}n The id of the DOM element
         * @param {*} object
         * @param {*} cell_size
         */
        const setupDraggable = (id, cell_size) => {
            let grid = window.grid;

            interact(`#${id}`).draggable({
                inertia: true,
                modifiers: [
                    // interact.modifiers.restrictRect({
                    //   restriction: "parent",
                    //   endOnly: true,
                    // }),
                    interact.modifiers.snap({
                        targets: [interact.snappers.grid({ x: cell_size, y: cell_size })],
                        // range: Infinity,
                        relativePoints: [{ x: 0, y: 0 }],
                    }),
                ],
                //   autoScroll: true,
                // dragMoveListener from the dragging demo above
                listeners: {
                    move: dragMoveListener,
                    end: (event) => dragEndListener(event, id, cell_size),
                },
            });
            //Resize is still TBD
            // .resizable({
            //   edges: {
            //     top: true,
            //     left: false,
            //     bottom: false,
            //     right: true,
            //   },
            //   snapSize: {
            //     // targets: [{ width: 100, height: 100, range: 100 }],
            //     targets: [
            //       interact.createSnapGrid({
            //         x: cell_size,
            //         y: cell_size,
            //         range: cell_size,
            //       }),
            //     ],
            //   },
            //   // modifiers: [
            //   //   interact.modifiers.aspectRatio({
            //   //     ratio: "equalDelta",
            //   //   }),
            //   // ],
            //   listeners: {
            //     move: (event) => {
            //       let { x, y } = event.target.dataset;

            //       x = (parseFloat(x) || 0) + event.deltaRect.left;
            //       y = (parseFloat(y) || 0) + event.deltaRect.top;

            //       // let image = document.querySelector("image", event.target);
            //       let image = event.target.getElementsByTagName("img")[0];
            //       Object.assign(image.style, {
            //         width: `${event.rect.width}px`,
            //         height: `${event.rect.height}px`,
            //       });
            //       Object.assign(event.target.style, {
            //         transform: `translate(${x}px, ${y}px)`,
            //       });
            //       Object.assign(event.target.dataset, { x, y });
            //     },
            //   },
            // });
        };
        /////////////////////////////////////////DRAGGING////////////////////////////////////////////////////
        // target elements with the "draggable" class
        // interact(".draggable").draggable({
        //   // enable inertial throwing
        //   inertia: true,
        //   // keep the element within the area of it's parent
        //   modifiers: [
        //     interact.modifiers.snap({
        //       targets: [interact.snappers.grid({ x: 300, y: 300 })],
        //       // range: Infinity,
        //       // relativePoints: [{ x: 0, y: 0 }]
        //     }),
        //     interact.modifiers.restrictRect({
        //       restriction: "parent",
        //       endOnly: true,
        //     }),
        //   ],
        //   // enable autoScroll
        //   autoScroll: true,

        //   listeners: {
        //     // call this function on every dragmove event
        //     move: dragMoveListener,

        //     // call this function on every dragend event
        //     end(event) {
        //       var textEl = event.target.querySelector("p");

        //       textEl &&
        //         (textEl.textContent =
        //           "moved a distance of " +
        //           Math.sqrt(
        //             (Math.pow(event.pageX - event.x0, 2) +
        //               Math.pow(event.pageY - event.y0, 2)) |
        //               0
        //           ).toFixed(2) +
        //           "px");
        //     },
        //   },
        // });

        /**
         * Stores the total delta in `data-x` and `data-y` properties
         * @param {*} event
         */
        function dragMoveListener(event) {
            console.log(event);
            var target = event.target;
            // keep the dragged position in the data-x/data-y attributes
            var x = (parseFloat(target.getAttribute("data-x")) || 0) + event.dx;
            var y = (parseFloat(target.getAttribute("data-y")) || 0) + event.dy;

            // translate the element
            target.style.transform = "translate(" + x + "px, " + y + "px)";

            // update the posiion attributes
            target.setAttribute("data-x", x);
            target.setAttribute("data-y", y);
        }
        function dragEndListener(event, id, cell_size) {
            let div = document.getElementById(id);
            let [type, obj_id] = id.split("-");
            let object;
            if (type === BOT_TYPE) {
                object = grid.bots[obj_id][0];
            } else if (type === OBSTACLE_TYPE) {
                object = grid.obstacles[obj_id][0];
            } else if (type === COIN_TYPE) {
                object = grid.coins[obj_id][0];
            } else {
                console.log(`In valid type ${type} from if '${id}'`);
            }
            // let dx = event.page.x - event.x0;
            // let dy = event.page.y - event.y0;
            let dx = Number(div.getAttribute("data-x") || 0);
            let dy = -Number(div.getAttribute("data-y") || 0); // the Y axis is backwards

            let di = Math.round(dx / cell_size);
            let dj = Math.round(dy / cell_size);
            let i = object.real_bottom_left[0] + di;
            let j = object.real_bottom_left[1] + dj;
            console.log(
                `Moved [${di}, ${dj}] from ${object.real_bottom_left} to ${[i, j]}`
            );
            // Try different methods depending on the type of object
            let res = {};
            if (type === BOT_TYPE) {
                res = grid.update_bot(object.id, {
                    real_bottom_left: [i, j],
                });
            } else if (type === OBSTACLE_TYPE) {
                res = grid.update_obstacle(object.id, {
                    real_bottom_left: [i, j],
                });
            } else if (type === COIN_TYPE) {
                res = grid.update_coin(object.id, {
                    real_bottom_left: [i, j],
                });
            } else {
                console.log(`In valid type ${type} from if '${id}'`);
            }
            let { success } = res;

            if (!success) {
                [i, j] = object.real_bottom_left; //Storing the original
            }
            div.style.left = `${cell_size * i}px`;
            div.style.bottom = `${cell_size * j}px`;

            //To put it back as new
            div.style.transform = null;
            div.removeAttribute("data-x");
            div.removeAttribute("data-y");
        }
        // this is used later in the resizing
        window.dragMoveListener = dragMoveListener;
        window.dragEndListener = dragEndListener;

        /////////////////////////////////////////DROPPING////////////////////////////////////////////////////
        // enable draggables to be dropped into this
        interact(".dropzone").dropzone({
            // only accept elements matching this CSS selector
            accept: "#yes-drop",
            // Require a 75% element overlap for a drop to be possible
            overlap: 0.75,

            // listen for drop related events:
            ondropactivate: function (event) {
                // add active dropzone feedback
                event.target.classList.add("drop-active");
            },
            ondragenter: function (event) {
                var draggableElement = event.relatedTarget;
                var dropzoneElement = event.target;

                // feedback the possibility of a drop
                dropzoneElement.classList.add("drop-target");
                draggableElement.classList.add("can-drop");
                // draggableElement.textContent = "Dragged in";
            },
            ondragleave: function (event) {
                // remove the drop feedback style
                event.target.classList.remove("drop-target");
                event.relatedTarget.classList.remove("can-drop");
                // event.relatedTarget.textContent = "Dragged out";
            },
            ondrop: function (event) {
                // event.relatedTarget.textContent = "Dropped";
            },
            ondropdeactivate: function (event) {
                // remove active dropzone feedback
                event.target.classList.remove("drop-active");
                event.target.classList.remove("drop-target");
            },
        });

        interact(".drag-drop").draggable({
            inertia: true,
            //   origin: "self",
            //   snap: {
            //     targets: [
            //       interact.createSnapGrid({
            //         x: 100,
            //         y: 100,
            //         // limit to the container dimensions
            //         limits: {
            //           left: 0,
            //           top: 0,
            //           right: 500 - 100,
            //           bottom: 500 - 100,
            //         },
            //       }),
            //     ],
            //     relativePoints: [{ x: 0, y: 0 }],
            //   },
            modifiers: [
                // interact.modifiers.restrictRect({
                //   restriction: "parent",
                //   endOnly: true,
                // }),
                interact.modifiers.snap({
                    targets: [interact.snappers.grid({ x: 100, y: 100 })],
                    // range: Infinity,
                    relativePoints: [{ x: 0, y: 0 }],
                }),
            ],
            //   autoScroll: true,
            // dragMoveListener from the dragging demo above
            listeners: { move: dragMoveListener },
        });
        interact(".drag-drop").resizable({
            //   origin: "self",
            edges: {
                top: true, // Use pointer coords to check for resize.
                left: true, // Disable resizing from left edge.
                bottom: true, // Resize if pointer target matches selector
                right: true, // Resize if pointer target is the given Element
            },
            snapSize: {
                // targets: [{ width: 100, height: 100, range: 100 }],
                targets: [
                    interact.createSnapGrid({
                        x: 100,
                        y: 100,
                        range: 100,
                    }),
                ],
            },
            listeners: {
                move: function (event) {
                    let { x, y } = event.target.dataset;

                    x = (parseFloat(x) || 0) + event.deltaRect.left;
                    y = (parseFloat(y) || 0) + event.deltaRect.top;

                    Object.assign(event.target.style, {
                        width: `${event.rect.width}px`,
                        height: `${event.rect.height}px`,
                        transform: `translate(${x}px, ${y}px)`,
                    });

                    Object.assign(event.target.dataset, { x, y });
                },
            },
        });

        /////////////////////////////////////////RESIZING////////////////////////////////////////////////////
        // interact(".resize-drag")
        //   .resizable({
        //     // resize from all edges and corners
        //     edges: { left: true, right: true, bottom: true, top: true },

        //     listeners: {
        //       move(event) {
        //         var target = event.target;
        //         var x = parseFloat(target.getAttribute("data-x")) || 0;
        //         var y = parseFloat(target.getAttribute("data-y")) || 0;

        //         // update the element's style
        //         target.style.width = event.rect.width + "px";
        //         target.style.height = event.rect.height + "px";

        //         // translate when resizing from top or left edges
        //         x += event.deltaRect.left;
        //         y += event.deltaRect.top;

        //         target.style.transform = "translate(" + x + "px," + y + "px)";

        //         target.setAttribute("data-x", x);
        //         target.setAttribute("data-y", y);
        //         target.textContent =
        //           Math.round(event.rect.width) +
        //           "\u00D7" +
        //           Math.round(event.rect.height);
        //       },
        //     },
        //     modifiers: [
        //       // keep the edges inside the parent
        //       interact.modifiers.restrictEdges({
        //         outer: "parent",
        //       }),

        //       // minimum size
        //       interact.modifiers.restrictSize({
        //         min: { width: 100, height: 50 },
        //       }),
        //     ],

        //     inertia: true,
        //   })
        //   .draggable({
        //     listeners: { move: window.dragMoveListener },
        //     inertia: true,
        //     modifiers: [
        //       interact.modifiers.restrictRect({
        //         restriction: "parent",
        //         endOnly: true,
        //       }),
        //     ],
        //   });

        export { setupDraggable };

    </script>

</body>

</html>